# Panduan Setup Kubernetes 3-Node Cluster

### Kubernetes v1.35.0 + containerd + Calico Tigera

Dokumentasi ini menjelaskan langkah-demi-langkah membuat cluster Kubernetes dengan:

- 1 Control Plane (Master) - otak dari cluster yang mengatur semuanya
- 2 Worker Node - server yang menjalankan aplikasi Anda
- Container runtime: **containerd** - software untuk menjalankan container
- CNI: **Calico Tigera** - software untuk networking antar pod
- Pod CIDR: **10.244.0.0/16** - range IP address untuk pod

---

## 1. Arsitektur & Topologi

Cluster akan memiliki struktur seperti di bawah ini:

| Role         | Hostname      | IP Address      | OS               | CPU | RAM |
|-------------|---------------|----------------|------------------|-----|-----|
| Master Node | `k8s-master`  | `192.168.2.104` | Debian 13 Trixie | 2+  | 4GB |
| Worker 1    | `k8s-worker1` | `192.168.2.105` | Debian 13 Trixie | 2+  | 4GB |
| Worker 2    | `k8s-worker2` | `192.168.2.106` | Debian 13 Trixie | 2+  | 4GB |

**‚ö†Ô∏è PENTING: Sesuaikan IP Address di atas dengan IP server Anda!**

**Minimal Spesifikasi yang Direkomendasikan:**
- CPU: 2 core
- RAM: 4GB
- Disk: 20GB+
- Internet aktif

> ‚úÖ Pastikan semua node bisa saling ping satu sama lain <br>


---

## 2. Tujuan Setup

Dengan panduan ini, Anda akan mendapatkan:

‚úî Sebuah cluster Kubernetes dengan 3 server (nodes)  
‚úî Worker node siap menjalankan aplikasi  
‚úî Jaringan pod menggunakan Calico  
‚úî Runtime container menggunakan containerd  

---

## 3. Persiapan Dasar (Wajib di Semua Node)

**üìç Langkah ini dilakukan di semua server:**
- `k8s-master`
- `k8s-worker1`
- `k8s-worker2`

### 3.1 Set Hostname (Di Semua Node)

Jalankan perintah sesuai dengan nama server masing-masing:

**Di Server Master:**
```bash
sudo hostnamectl set-hostname k8s-master
```

**Di Server Worker 1:**
```bash
sudo hostnamectl set-hostname k8s-worker1
```

**Di Server Worker 2:**
```bash
sudo hostnamectl set-hostname k8s-worker2
```

---

### 3.2 Tambahkan Hosts Mapping (di Semua Node)

Tujuannya agar setiap server bisa saling mengenali menggunakan nama, bukan hanya IP address.

Edit file hosts:
```bash
sudo vim /etc/hosts
```

Tambahkan baris ini di paling bawah (sesuaikan dengan IP server Anda):
```
192.168.2.104 k8s-master
192.168.2.105 k8s-worker1
192.168.2.106 k8s-worker2
```

**Tekan `Ctrl + X`, lalu `Y`, dan `Enter` untuk menyimpan.**

---

### 3.3 Disable Swap (di Semua Node)

Swap harus dimatikan karena Kubernetes memerlukan kontrol penuh terhadap memory.

```bash
sudo swapoff -a
sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
```

**Penjelasan:** Perintah pertama mematikan swap sementara, perintah kedua memastikan swap tetap mati setelah reboot.

---

### 3.4 Aktifkan Kernel Modules (di Semua Nodes)

Pengaktifan modul-modul kernel dibutuhkan agar container dapat berjalan dengan baik.

```bash
sudo tee /etc/modules-load.d/containerd.conf <<EOF
overlay
br_netfilter
EOF
```

Kemudian load module tersebut:

```bash
sudo modprobe overlay
sudo modprobe br_netfilter
```

**Penjelasan Singkat:**

Proses ini bertujuan untuk mengaktifkan fitur inti pada Kernel Linux agar siap menjalankan beban kerja Kubernetes:

* **Modul overlay:** Dibutuhkan agar containerd dapat mengelola sistem penyimpanan berlapis (layering) pada kontainer. Tanpa ini, kontainer tidak bisa dibuat.

* **Modul br_netfilter:** Dibutuhkan agar trafik jaringan yang melewati bridge virtual (antar Pod) dapat diproses oleh sistem firewall Linux (iptables). Tanpa ini, komunikasi antar Pod akan terputus.

**Efek pada Sistem:**

* Perintah tee membuat file di /etc/modules-load.d/ agar modul selalu aktif otomatis saat komputer menyala (booting).

* Perintah modprobe langsung mengaktifkan modul ke memori saat ini tanpa perlu melakukan restart.

---

### 3.5 Konfigurasi Networking (Sysctl, Jalankan di Semua Nodes)

```bash
sudo tee /etc/sysctl.d/kubernetes.conf <<EOT
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
EOT
```

Terapkan konfigurasi:

```bash
sudo sysctl --system
```

**Penjelasan:** Konfigurasi ini mengaktifkan IP forwarding agar Pod dapat berkomunikasi satu sama lain.

---

## 4. Install containerd (di Semua Node)

containerd adalah software yang menjalankan container di dalam Kubernetes.

### 4.1 Install Dependencies (di Semua Node)

Update package list dan install tools yang dibutuhkan:

```bash
sudo apt update
sudo apt install -y curl gnupg2 apt-transport-https ca-certificates
```

Setelah instalasi selesai, komponen-komponen tersebut tersebar di direktori berikut:

* Binary (File Eksekusi): 
  1. **/usr/bin/curl** 
  2. **dan /usr/bin/gpg**

* Konfigurasi: 
  1. **/etc/ssl/certs/** 
  2. **dan /etc/gnupg/**

* Library: 
  1. **/usr/lib/x86_64-linux-gnu/**

---

### 4.2 Tambahkan Repository Docker (di Semua Node)

Tambahkan GPG key dari Docker:

```bash
sudo curl -fsSL https://download.docker.com/linux/debian/gpg | \
sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
```

Beri permission untuk membaca file:

```bash
sudo chmod a+r /etc/apt/keyrings/docker.gpg
```

Tambahkan repository Docker:

```bash
echo \
"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
https://download.docker.com/linux/debian \
bookworm stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```

---

### 4.3 Install containerd (di Semua Node)

Update package list dan install containerd:

```bash
sudo apt-get update
sudo apt-get install -y containerd.io
```

Lokasi Instalasi Tools:

* Binary (Eksekusi): **/usr/bin/containerd** (CLI bawaan containerd).

* Systemd Service: **/lib/systemd/system/containerd.service** (File yang mengatur cara containerd berjalan otomatis).

* Data Root: **/var/lib/containerd/** (Tempat penyimpanan images, metadata, dan konten kontainer).

* Runtime State: **/run/containerd/** (Tempat penyimpanan data sementara saat kontainer sedang berjalan).

---

### 4.4 Generate Default Config (di Semua Node)

Buat folder konfigurasi dan generate config default:

```bash
sudo mkdir -p /etc/containerd
sudo containerd config default | sudo tee /etc/containerd/config.toml
```

---

### 4.5 Gunakan Systemd Cgroup Driver (di Semua Node)

Edit konfigurasi agar menggunakan systemd:

```bash
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
```

Restart containerd dan cek statusnya:

```bash
sudo systemctl restart containerd
sudo systemctl enable containerd
sudo systemctl status containerd
```

> ‚úÖ Pastikan status menunjukkan **active (running)**. Tekan `q` untuk keluar dari tampilan status.

---

## 5. Install Kubernetes (di Semua Node)

### 5.1 Tambahkan Repository Kubernetes (di Semua Node)

Update dan install tools yang dibutuhkan:

```bash
sudo apt-get update
sudo apt-get install -y curl gpg
```

Tambahkan GPG key Kubernetes:

```bash
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.35/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
```

Tambahkan repository Kubernetes:

```bash
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.35/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
```

---

### 5.2 Install Package Kubernetes (di Semua Node)

Update dan install komponen Kubernetes:

```bash
sudo apt-get update
sudo apt-get install -y kubeadm kubectl kubelet
```

Kunci versi agar tidak auto-update:

```bash
sudo apt-mark hold kubeadm kubectl kubelet
```

**Penjelasan:**
- **kubeadm** - tool untuk setup cluster
- **kubectl** - command line untuk kontrol Kubernetes
- **kubelet** - service yang berjalan di setiap node

**Lokasi Instalasi Komponen:**
#### 5.2.1. File Eksekusi (Binaries)

Semua perintah utama diletakkan di folder binary standar agar bisa dipanggil langsung dari terminal:

* **/usr/bin/kubeadm**: Alat untuk inisialisasi dan manajemen cluster.

* **/usr/bin/kubectl**: Alat baris perintah untuk berinteraksi dengan cluster.

* **/usr/bin/kubelet**: Agen utama yang berjalan di setiap node.

#### 5.2.2. Konfigurasi dan Manifest

Folder ini sangat penting untuk operasional Kubernetes:

* **/etc/kubernetes/**: Folder utama untuk konfigurasi cluster (berisi file admin.conf, manifest untuk API server, scheduler, dll).

* **/etc/kubernetes/manifests/**: Tempat penyimpanan file YAML untuk static pods seperti etcd, api-server, controller-manager, dan scheduler (hanya ada jika cluster sudah di-setup).

* **/etc/default/kubelet**: File konfigurasi lingkungan untuk layanan kubelet.

#### 5.2.3. Systemd Service (Layanan Latar Belakang)

Khusus untuk kubelet, karena ia harus selalu berjalan di latar belakang:

* **/lib/systemd/system/kubelet.service**: File unit systemd yang mengatur cara kubelet berjalan.

* **/etc/systemd/system/kubelet.service.d/**: Folder untuk konfigurasi tambahan (drop-ins) bagi layanan kubelet.

#### 5.2.4. Data dan State

Tempat Kubernetes menyimpan data runtime:

* **/var/lib/kubelet/**: Direktori kerja utama kubelet (berisi data volume, pods, dan informasi internal node).

* **/var/lib/etcd/**: (Hanya di Control Plane) Tempat database utama Kubernetes disimpan.

---

## 6. Inisialisasi Cluster (Master Node Saja)

**‚ö†Ô∏è HANYA jalankan di Master Node!**

Inisialisasi cluster dengan perintah berikut (sesuaikan IP master Anda):

```bash
sudo kubeadm init --pod-network-cidr=10.244.0.0/16 --control-plane-endpoint=192.168.2.104
```

**üìù PENTING:** Simpan output yang berisi perintah `kubeadm join ...` karena akan digunakan di worker node nanti!

Contoh output yang harus disimpan:
```
kubeadm join 192.168.2.104:6443 --token abc123.xyz789 \
--discovery-token-ca-cert-hash sha256:1234567890abcdef...
```

### 6.1 Konfigurasi kubectl (Hanya di Master Node Saja)

Agar kubectl bisa digunakan tanpa sudo:

```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

Verifikasi bahwa kubectl sudah bisa digunakan:

```bash
kubectl get nodes
```

Anda akan melihat master node dengan status `NotReady` - ini normal karena networking belum terinstall.

---

## 7. Install Calico Tigera (Hanya di Master Node Saja)

Calico adalah plugin networking yang membuat pod bisa berkomunikasi.

### 7.1 Install Operator (Hanya di Master Node Saja)

```bash
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/tigera-operator.yaml
```

---

### 7.2 Download Konfigurasi Jaringan (Hanya di Master Node Saja)

```bash
wget https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/custom-resources.yaml
```

---

### 7.3 Edit File custom-resources.yaml

Buka file dengan vim:

```bash
vim custom-resources.yaml
```

Cari bagian `cidr: 192.168.0.0/16` dan **UBAH** menjadi `10.244.0.0/16`

Hasil akhir seharusnya seperti ini:

```yaml
apiVersion: operator.tigera.io/v1
kind: Installation
metadata:
  name: default
spec:
  calicoNetwork:
    ipPools:
    - blockSize: 26
      cidr: 10.244.0.0/16
      encapsulation: VXLANCrossSubnet
      natOutgoing: Enabled
      nodeSelector: all()
```

**Tekan `Ctrl + X`, lalu `Y`, dan `Enter` untuk menyimpan.**

---

### 7.4 Apply Konfigurasi

```bash
kubectl create -f custom-resources.yaml
```

---

### 7.5 Verifikasi Pods Calico

Tunggu beberapa saat, lalu cek status pods Calico:

```bash
kubectl get pods -n calico-system
```

Tunggu sampai semua pods menunjukkan status `Running`. Ini bisa memakan waktu 2-5 menit.

Cek kembali nodes:

```bash
kubectl get nodes
```

Master node sekarang seharusnya sudah `Ready`!

---

## 8. Join Worker Node ke Master (Worker Node Saja)

**‚ö†Ô∏è Sebelum melakukan langkah ini, pastikan Worker Node sudah menyelesaikan langkah 3, 4, dan 5!**

### 8.1 Join Worker ke Cluster (Di Worker Node)

Di setiap worker node, jalankan perintah `kubeadm join` yang Anda simpan dari langkah 6:

```bash
sudo kubeadm join 192.168.2.104:6443 --token abc123.xyz789 \
--discovery-token-ca-cert-hash sha256:1234567890abcdef...
```

**Jika lupa token**, jalankan perintah ini di master node:

```bash
kubeadm token create --print-join-command
```

### 8.2 Troubleshooting: Error CRI 

Jika muncul error seperti ini:

```
[ERROR CRI]: could not connect to the container runtime...
unknown service runtime.v1.RuntimeService
```

**Solusi:**

Buka file config containerd:

```bash
sudo vim /etc/containerd/config.toml
```

Cari baris:

```toml
disabled_plugins = ["cri"]
```

Ubah menjadi (kosongkan kurungnya):

```toml
disabled_plugins = []
```

**Tekan `Ctrl + X`, lalu `Y`, dan `Enter` untuk menyimpan.**

Restart containerd:

```bash
sudo systemctl restart containerd
```

Ulangi perintah `kubeadm join`.

---

## 9. Verifikasi Cluster (Di Master Node)

Kembali ke master node, cek semua nodes:

```bash
kubectl get nodes
```

Output yang diharapkan:

```
NAME          STATUS   ROLES           AGE   VERSION
k8s-master    Ready    control-plane   10m   v1.35.0
k8s-worker1   Ready    <none>          5m    v1.35.0
k8s-worker2   Ready    <none>          5m    v1.35.0
```

‚úÖ Semua node harus menunjukkan status `Ready`!

Cek semua pods di cluster:

```bash
kubectl get pods -A
```

Semua pods harus berstatus `Running`.

---

## 10. Hasil Akhir

Selamat! Anda sekarang memiliki:

‚úî Kubernetes v1.35.0 yang berfungsi penuh  
‚úî 1 Control Plane (Master Node)  
‚úî 2 Worker Nodes  
‚úî containerd sebagai Container Runtime  
‚úî Calico Tigera untuk Networking  

Cluster siap digunakan untuk deploy aplikasi! üöÄ

---

## 11. Install Metrics Server (Master Node Saja)

Metrics Server adalah komponen yang mengumpulkan data penggunaan CPU dan Memory dari setiap node dan pod. Data ini berguna untuk:
- Melihat resource usage dengan `kubectl top`
- Auto-scaling (HPA - Horizontal Pod Autoscaler)
- Monitoring performa cluster

### 11.1 Install Metrics Server

Jalankan perintah berikut di master node:

```bash
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
```

---

### 11.2 Konfigurasi Metrics Server

Karena kita menggunakan cluster self-hosted (bukan cloud provider), kita perlu menambahkan flag `--kubelet-insecure-tls` agar Metrics Server bisa berkomunikasi dengan kubelet.

**Ada 2 cara untuk melakukan ini:**

#### Cara 1: Menggunakan kubectl patch (Lebih Cepat)

```bash
kubectl patch deployment metrics-server -n kube-system --type='json' -p='[{"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--kubelet-insecure-tls"}]'
```

#### Cara 2: Edit Manual (Lebih Jelas)

Jika cara 1 tidak berhasil atau Anda ingin lebih memahami konfigurasinya:

Edit deployment Metrics Server:

```bash
kubectl edit deployment metrics-server -n kube-system
```

Cari bagian `spec` ‚Üí `containers` ‚Üí `args`. Akan terlihat seperti ini:

```yaml
args:
- --cert-dir=/tmp
- --secure-port=4443
- --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
- --kubelet-use-node-status-port
- --metric-resolution=15s
```

Tambahkan satu baris `- --kubelet-insecure-tls` di dalam daftar args:

```yaml
args:
- --cert-dir=/tmp
- --secure-port=4443
- --kubelet-insecure-tls                                        # <-- TAMBAHKAN INI
- --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
- --kubelet-use-node-status-port
- --metric-resolution=15s
```

**‚ö†Ô∏è PENTING:** 
- Gunakan **SPASI untuk indentasi**, BUKAN TAB
- Pastikan posisi `-` sejajar dengan baris lainnya
- Tekan `Esc`, ketik `:wq`, lalu `Enter` untuk menyimpan dan keluar

---

### 11.3 Verifikasi Metrics Server

Tunggu beberapa saat, lalu cek status pod Metrics Server:

```bash
kubectl get pods -n kube-system | grep metrics
```

Output yang diharapkan:
```
metrics-server-xxxxxxxxxx-xxxxx   1/1     Running   0          2m
```

**Tunggu sampai status menjadi `Running`!**

---

### 11.4 Test Metrics Server

Setelah pod Metrics Server running, test dengan melihat resource usage:

**Lihat penggunaan resource di semua nodes:**
```bash
kubectl top nodes
```

Output contoh:
```
NAME          CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%
k8s-master    250m         12%    1500Mi          37%
k8s-worker1   150m         7%     800Mi           20%
k8s-worker2   180m         9%     900Mi           22%
```

**Lihat penggunaan resource semua pods:**
```bash
kubectl top pods -A
```

‚úÖ Jika perintah di atas berhasil menampilkan data, berarti Metrics Server sudah berfungsi dengan baik!

---

### 11.5 Troubleshooting Metrics Server

**Jika muncul error "Metrics API not available":**

Tunggu 1-2 menit, karena Metrics Server perlu waktu untuk mengumpulkan data pertama kali.

**Jika tetap error setelah 5 menit:**

Cek log Metrics Server:
```bash
kubectl logs -n kube-system deployment/metrics-server
```

Pastikan tidak ada error yang berkaitan dengan certificate atau connection.

**Jika pod CrashLoopBackOff:**

Restart deployment:
```bash
kubectl rollout restart deployment metrics-server -n kube-system
```

---

## 12. Test Deployment Sederhana (Opsional)

Untuk memastikan cluster benar-benar berfungsi, coba deploy aplikasi sederhana:

```bash
kubectl create deployment nginx --image=nginx
kubectl expose deployment nginx --port=80 --type=NodePort
kubectl get pods
kubectl get services
```

Akses nginx melalui browser: `http://<IP-worker-node>:<NodePort>`

Lihat resource usage nginx:
```bash
kubectl top pod
```

Hapus test deployment:

```bash
kubectl delete deployment nginx
kubectl delete service nginx
```

---

## 13. Struktur Direktori Tools

Sebagai referensi, berikut adalah daftar folder utama yang digunakan oleh seluruh komponen Kubernetes dan Container Runtime yang telah diinstal:

### 13.1 Komponen Utama Kubernetes

Komponen-komponen ini (`kubeadm`, `kubectl`, `kubelet`) diinstal dan tersebar di beberapa lokasi sistem:

* **/usr/bin/**: Berisi file binary (eksekusi) untuk `kubeadm`, `kubectl`, dan `kubelet`.

* **/etc/kubernetes/**: Folder konfigurasi utama cluster. Di sinilah file `admin.conf` (untuk akses cluster) dan manifes static pods berada, yaitu `etcd`, `api-server`, `controller-manager`, dan `scheduler`.

* **/etc/kubernetes/manifests/**: Tempat penyimpanan file YAML untuk static pods (hanya ada setelah cluster di-inisialisasi dengan `kubeadm init`).

* **/etc/default/kubelet**: File konfigurasi lingkungan untuk layanan kubelet.

* **/lib/systemd/system/kubelet.service**: File unit systemd yang mengatur cara kubelet berjalan sebagai layanan latar belakang.

* **/etc/systemd/system/kubelet.service.d/**: Folder untuk konfigurasi tambahan (drop-ins) bagi layanan kubelet.

* **/var/lib/kubelet/**: Direktori kerja internal kubelet. Berisi data terkait Pod yang berjalan di node tersebut, termasuk volumes dan plugins.

* **/var/log/pods/** & **/var/log/containers/**: Lokasi penyimpanan log aplikasi yang berjalan di dalam cluster.

---

### 13.2 Container Runtime (containerd)

containerd bertanggung jawab atas siklus hidup kontainer (pull, run, stop):

* **/usr/bin/containerd**: File eksekusi utama containerd.

* **/usr/bin/crictl**: CLI tool untuk berinteraksi langsung dengan container runtime melalui CRI (Container Runtime Interface).

* **/etc/containerd/config.toml**: File konfigurasi utama containerd, termasuk pengaturan cgroup driver dan plugin.

* **/lib/systemd/system/containerd.service**: File unit systemd yang mengatur cara containerd berjalan otomatis.

* **/var/lib/containerd/**: Folder penyimpanan data "berat". Di sinilah seluruh images (seperti Nginx, Calico, dll) dan layer sistem file kontainer disimpan.

* **/run/containerd/**: Berisi data runtime sementara seperti socket (`/run/containerd/containerd.sock`) dan ID proses. Data ini akan dihapus jika sistem melakukan reboot.

---

### 13.3 Database Cluster (etcd)

etcd adalah otak dari Kubernetes yang menyimpan seluruh status cluster:

* **/var/lib/etcd/**: Lokasi database utama. Semua objek yang dibuat dengan `kubectl create` (seperti Deployment, Service, atau ConfigMap) disimpan di sini dalam bentuk data terstruktur, bukan file YAML mentah.

---

### 13.4 Konfigurasi Networking (CNI / Calico)

Khusus untuk pengaturan jaringan antar pod:

* **/etc/cni/net.d/**: Berisi file konfigurasi jaringan (seperti `10-calico.conflist`).

* **/opt/cni/bin/**: Tempat penyimpanan file binary jaringan yang digunakan oleh Kubernetes untuk memberikan IP ke setiap Pod.

---

### 13.5 Tabel Ringkasan Lokasi File

| Komponen | Jenis Data | Jalur Folder (Path) |
|---|---|---|
| Semua Tools | Eksekusi (Binary) | `/usr/bin/` |
| Kubernetes Config | Konfigurasi Cluster | `/etc/kubernetes/` |
| Kubelet Data | Pods & Volumes | `/var/lib/kubelet/` |
| Containerd Config | Konfigurasi Runtime | `/etc/containerd/` |
| Containerd Data | Image & Snapshots | `/var/lib/containerd/` |
| Containerd Socket | Runtime State (sementara) | `/run/containerd/` |
| etcd | Database Cluster | `/var/lib/etcd/` |
| Networking | Config CNI | `/etc/cni/net.d/` |
| Networking | Binary CNI | `/opt/cni/bin/` |
| Log | Pod & Container Logs | `/var/log/pods/` & `/var/log/containers/` |

> **üìçNote!**: gunakan perintah **sudo crictl images** untuk melihat size image yang ada di node. untuk menghapus image yang tidak terpakai, gunakan perintah **sudo crictl rmi --prune**.

---

## 14. Perintah Berguna

### Perintah Dasar
```bash
# Lihat semua nodes
kubectl get nodes

# Lihat semua pods di semua namespace
kubectl get pods -A

# Lihat pods di namespace tertentu
kubectl get pods -n <namespace>

# Lihat detail node
kubectl describe node k8s-master

# Lihat log pod
kubectl logs <nama-pod> -n <namespace>

# Restart deployment
kubectl rollout restart deployment <nama-deployment>
```

### Perintah Monitoring (Setelah Install Metrics Server)
```bash
# Lihat penggunaan CPU dan Memory nodes
kubectl top nodes

# Lihat penggunaan CPU dan Memory pods
kubectl top pods -A

# Lihat penggunaan resource pod tertentu
kubectl top pod <nama-pod> -n <namespace>

# Lihat penggunaan resource dengan sorting
kubectl top pods -A --sort-by=cpu
kubectl top pods -A --sort-by=memory
```

### Perintah crictl (Container Runtime Interface)

`crictl` adalah CLI tool untuk berinteraksi langsung dengan containerd tanpa melalui Kubernetes. Berguna untuk debugging di level container runtime, terutama saat `kubectl` tidak tersedia atau node belum join ke cluster.

> ‚ö†Ô∏è **Catatan:** Semua perintah `crictl` memerlukan akses root (`sudo`).

**Melihat Container yang Sedang Berjalan:**
```bash
# Lihat semua container yang sedang running
sudo crictl ps

# Lihat semua container termasuk yang sudah stopped/exited
sudo crictl ps -a

# Lihat container dengan output lebih detail
sudo crictl ps -v
```

**Melihat dan Mengelola Images:**
```bash
# Lihat semua image yang sudah di-pull di node ini
sudo crictl images

# Lihat image dengan detail (ukuran, digest, dll)
sudo crictl images -v

# Pull image dari registry
sudo crictl pull nginx:latest

# Hapus image tertentu (gunakan Image ID dari output crictl images)
sudo crictl rmi <image-id>

# Hapus semua image yang tidak digunakan
sudo crictl rmi --prune
```

**Inspeksi dan Debugging Container:**
```bash
# Lihat detail/inspect sebuah container (gunakan Container ID dari crictl ps)
sudo crictl inspect <container-id>

# Lihat log dari sebuah container
sudo crictl logs <container-id>

# Lihat log secara real-time (follow)
sudo crictl logs -f <container-id>

# Masuk ke dalam container (exec)
sudo crictl exec -it <container-id> /bin/sh
```

**Melihat Pods di Level Runtime:**
```bash
# Lihat semua pod sandbox yang dikelola containerd
sudo crictl pods

# Lihat pod sandbox dengan detail
sudo crictl pods -v

# Lihat detail pod sandbox tertentu
sudo crictl inspectp <pod-id>
```

**Informasi dan Status Runtime:**
```bash
# Cek status dan info container runtime
sudo crictl info

# Lihat statistik resource (CPU, Memory) semua container
sudo crictl stats

# Lihat statistik resource container tertentu
sudo crictl stats <container-id>
```

### Perintah Troubleshooting
```bash
# Lihat events cluster
kubectl get events -A --sort-by='.lastTimestamp'

# Lihat status semua resources
kubectl get all -A

# Cek konfigurasi cluster
kubectl cluster-info

# Cek versi Kubernetes
kubectl version --short

# Describe pod untuk melihat detail error
kubectl describe pod <nama-pod> -n <namespace>
```

---

## 15. Referensi

- [Dokumentasi Kubernetes](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm)
- [Dokumentasi Calico](https://projectcalico.docs.tigera.io)
- [Dokumentasi containerd](https://containerd.io)
- [Dokumentasi Metrics Server](https://github.com/kubernetes-sigs/metrics-server)
- [Dokumentasi crictl](https://kubernetes.io/docs/tasks/debug/debug-cluster/crictl/)

---

**üí° Tips:**
- Simpan kubeconfig (`~/.kube/config`) sebagai backup
- Gunakan `kubectl get events` untuk troubleshooting di level Kubernetes
- Gunakan `sudo crictl ps` untuk troubleshooting di level container runtime
- Monitoring resource dengan `kubectl top nodes` setelah install Metrics Server
- Gunakan `kubectl explain <resource>` untuk melihat dokumentasi resource (contoh: `kubectl explain pod`)
- Install `kubectx` dan `kubens` untuk switching context dan namespace dengan mudah